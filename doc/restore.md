# Процедуры по восстановлению с резервной SD-карты

Резервная SD-карта - это когда-то сделанная копия основной после полной установки согласно [Инструкции](INSTALL.md).

В целом - она готова к использованию как есть. Однако, некоторые моменты, появившиеся в процессе
эксплуатации основной SD-карты, рекомендуется перенести и на копию при введении её в боевую работу.

## Проверяем системные часы

Убеждаемся, что системные часы идут верно:

* либо на мониторе взлётов (текущее время),

* либо при выполнении в консоли команды:

        date

### Установка часового пояса (если требуется)

Выполняем:

    tzsetup

Отвечаем:

    Is this machine's CMOS clock set to UTC?
    
    No -> Europe -> Russian Federation -> MSK+00 - Moscow area

На вопрос:

    Does the abbreviation `MSK' look reasonable?
    
    Yes

### Принудительная синхронизация часов

Выполняем (можно указать только один хост):

    /usr/sbin/ntpdate -u 0.ru.pool.ntp.org 1.ru.pool.ntp.org 2.ru.pool.ntp.org

В ответе будет число секунд, на которое поправилось время. Если там больше, чем на полчаса,
то лучше перезагрузить сервер перед продолжением.

## Восстановление базы пользователей

Пользователи системы оповещения о взлётах хранятся в отдельной БД на постоянной основе.
Это единственное, что хранится и не стирается автоматически.

При потере этой базы всем пользователям придётся регистрироваться заново.

Чтобы это не пришлось делать, файлы из папки /home/redis старой флешки необходимо перенести на новую.

* Подключаем старую (нерабочую) SD-карту через любой USB-кардридер

* Выполняем команды

        /usr/local/etc/rc.d/redis stop
        
        mount /dev/da0s2a /mnt
        cp /mnt/home/redis/* /home/redis/
        cp /mnt/home/manifest/redefine.conf /home/manifest/
        
        umount /mnt
        
        /usr/local/etc/rc.d/redis start

При этом будут перенесены настройки Telegram-бота и другие локальные донастройки ПО.

## Обновление ПО `Монитора Взлётов`

Выполняем команды:

    cd /home/manifest
    ./export.master.sh

